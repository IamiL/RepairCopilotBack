# /etc/maddy/maddy.conf
# Домены
hostname mail.intbis.ru
domain intbis.ru

# Хранилище и пользователи
storage fs /var/lib/maddy
auth.passwd /var/lib/maddy/passwd

# TLS (используем LE от nginx)
tls file /certs/fullchain.pem /certs/privkey.pem

# DKIM (ключ создадим ниже; селектор m1)
dkim.signer {
    domain intbis.ru
    selector m1
    private_key /var/lib/maddy/dkim/intbis.ru/m1.key
    header_canon relaxed
    body_canon relaxed
}

# Входящая почта (при желании можно отключить imap, если нужно только отправлять)
imap tls://0.0.0.0:993 {
    auth &authdb
    storage &maildir
}

# SMTP приём (25)
smtp tcp://0.0.0.0:25 {
    hostname mail.intbis.ru
    filter check:reject_invalid_helo
    tls on
    dkim.verify on
    spf.check on
    # Антиспам можно подключить позже через rspamd
    delivery &local_or_relay
}

# SMTP Submission (587) для клиентов/приложений
submission tcp://0.0.0.0:587 {
    hostname mail.intbis.ru
    auth &authdb
    tls starttls
    require_auth on
    dkim.sign on
    delivery &remote_mta
}

# SMTPS (465) — опционально
smtps tls://0.0.0.0:465 {
    hostname mail.intbis.ru
    auth &authdb
    dkim.sign on
    delivery &remote_mta
}

# Куда доставлять
table &authdb auth.passwd /var/lib/maddy/passwd
table &maildir fs.maildir /var/lib/maddy/mailboxes

# Локальная доставка в ящики домена или релей наружу, если нет локального ящика
route &local_or_relay {
    rcpt_to.local {
        deliver_to &maildir
    }
    default {
        deliver_to &remote_mta
    }
}

# Исходящие — напрямую в интернет
deliver &remote_mta smtp {
    helo mail.intbis.ru
    dsn on
    tls on
    # Если порт 25 у провайдера закрыт — раскомментируйте и заполните смарт-хост:
    # upstream smtp://USERNAME:PASS@smtp.mailjet.com:587
}
