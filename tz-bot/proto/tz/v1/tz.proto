syntax = "proto3";

package tz.v1;

option go_package = "repairCopilotBot/tz-bot/proto/tz/v1;tzv1";


import "google/protobuf/timestamp.proto";

service TzService {
  rpc CheckTz(CheckTzRequest) returns (CheckTzResponse);
  rpc GetTechnicalSpecificationVersions(GetTechnicalSpecificationVersionsRequest) returns (GetTechnicalSpecificationVersionsResponse);
  rpc GetAllVersionsAdminDashboard(GetAllVersionsAdminDashboardRequest) returns (GetAllVersionsAdminDashboardResponse);
  rpc GetVersionStatistics(GetVersionStatisticsRequest) returns (GetVersionStatisticsResponse);
  rpc GetVersion(GetVersionRequest) returns (GetVersionResponse);
  rpc NewFeedbackError(NewFeedbackErrorRequest) returns (NewFeedbackErrorResponse);
  rpc GetVersionsDateRange(GetVersionsDateRangeRequest) returns (GetVersionsDateRangeResponse);
  rpc GetDailyAnalytics(GetDailyAnalyticsRequest) returns (GetDailyAnalyticsResponse);
  rpc GetFeedbacks(GetFeedbacksRequest) returns (GetFeedbacksResponse);
}

message CheckTzRequest {
  bytes file = 1;
  string filename = 2;
  string request_id = 3;
}

message CheckTzResponse {
  string id = 1;
  string name = 2;
  google.protobuf.Timestamp created_at = 3;
}

message Error {
  string id = 1;
  string group_id = 2;
  string error_code = 3;
  string name = 4;
  string description = 5;
  string detector = 6;
  optional string preliminary_notes = 7;
  optional string overall_critique = 8;
  string verdict = 9;
  optional string process_analysis = 10;
  optional string process_critique = 11;
  optional string process_verification = 12;
  repeated string process_retrieval = 13;
  repeated InvalidInstance invalid_instances = 14;
  repeated MissingInstance missing_instances = 15;
  int32 order_number = 16;
}

message InvalidInstance {
  string id = 1;
  uint32 html_id = 2;
  string error_id = 3;
  string rationale = 4;
  string quote = 5;
  string suggested_fix = 6;
  string original_quote = 7;
  repeated string quote_lines = 8;
  bool until_the_end_of_sentence = 9;
  optional int32 start_line_number = 10;
  optional int32 end_line_number = 11;
  string system_comment = 12;
  int32 order_number = 13;
  optional Error parent_error = 14;
  bool feedback_exists = 16;
  optional bool feedback_mark = 17;
  optional string feedback_comment = 18;
  optional string feedback_user = 19;
  bool feedback_verification_exists = 20;
  optional bool feedback_verification_mark = 21;
  optional string feedback_verification_comment = 22;
  optional string feedback_verification_user = 23;
}

message MissingInstance {
  string id = 1;
  uint32 html_id = 2;
  string error_id = 3;
  string suggested_fix = 4;
  string rationale = 5;
  bool feedback_exists = 16;
  optional bool feedback_mark = 17;
  optional string feedback_comment = 18;
  optional string feedback_user = 19;
  bool feedback_verification_exists = 20;
  optional bool feedback_verification_mark = 21;
  optional string feedback_verification_comment = 22;
  optional string feedback_verification_user = 23;
}

message GetTechnicalSpecificationVersionsRequest {
  string user_id = 1;
}

message GetTechnicalSpecificationVersionsResponse {
  repeated TechnicalSpecificationVersion versions = 1;
}

message TechnicalSpecificationVersion {
  string version_id = 1;
  string technical_specification_name = 2;
  int32 version_number = 3;
  string created_at = 4;
  string original_file_link = 5;
  string report_file_link = 6;
}

message GetVersionRequest {
  string version_id = 1;
}

message GetVersionResponse {
  optional string html_text = 1;
  optional string css = 2;
  optional string docId = 3;
  optional string fileId = 4;
  repeated Error errors = 5;
  repeated InvalidInstance invalid_instances = 6;
  google.protobuf.Timestamp created_at = 7;
  optional double total_rubs = 8;
  optional int64 total_tokens = 9;
  optional int64 average_inspection_time_nanoseconds = 10;
  optional int64 original_file_size = 11;
  optional int32 numberOfErrors = 12;
  string name = 13;
  string status = 14;
}

message GetAllVersionsAdminDashboardRequest {
  // No parameters needed - returns all versions
}

message GetAllVersionsAdminDashboardResponse {
  repeated VersionAdminDashboard versions = 1;
}

message VersionAdminDashboard {
  string version_id = 1;
  string technical_specification_name = 3;
  string user_id = 4;
  int32 version_number = 5;
  int64 all_tokens = 6;
  double all_rubs = 7;
  int32 number_of_errors = 8;
  int64 inspection_time = 9;
  int64 original_file_size = 10;
  int32 number_of_pages = 11;
  google.protobuf.Timestamp created_at = 12;
  string original_file_link = 13;
  string report_file_link = 14;
}

message GetVersionStatisticsRequest {
  // No parameters needed - returns statistics for all versions
}

message GetVersionStatisticsResponse {
  VersionStatistics statistics = 1;
}

message VersionStatistics {
  int64 total_versions = 1;
  optional int64 total_tokens = 2;
  optional double total_rubs = 3;
  optional int64 average_inspection_time_nanoseconds = 4;
}

message NewFeedbackErrorRequest {
  string instance_id = 1;
  string instance_type = 2;
  optional bool feedback_mark = 3;
  optional string feedback_comment = 4;
  string user_id = 5;
}

message NewFeedbackErrorResponse {
}

message GetVersionsDateRangeRequest {
  // No parameters needed - returns date range for all versions
}

message GetVersionsDateRangeResponse {
  string min_date = 1; // Format: 2024-01-01
  string max_date = 2; // Format: 2024-01-01
}

message GetDailyAnalyticsRequest {
  string from_date = 1;    // Format: YYYY-MM-DD (required)
  string to_date = 2;      // Format: YYYY-MM-DD (required, inclusive)
  optional string timezone = 3; // IANA timezone (e.g., Asia/Almaty)
  optional string group_by = 4; // default: "day"
  repeated string metrics = 5;  // consumption,toPay,tz (if empty - return all)
}

message GetDailyAnalyticsResponse {
  repeated DailyAnalyticsPoint series = 1;
}

message DailyAnalyticsPoint {
  string date = 1;                 // Format: YYYY-MM-DD
  optional int64 consumption = 2;  // all_tokens sum for the day
  optional double to_pay = 3;      // all_rubs sum for the day  
  optional int32 tz = 4;           // count of versions for the day
}

message GetFeedbacksRequest {
  optional string user_id = 1; // If provided, filter feedbacks by this user_id
}

message GetFeedbacksResponse {
  repeated FeedbackInstance feedbacks = 1;
}

message FeedbackInstance {
  string instance_id = 1;                        // UUID of invalid_instance or missing_instance
  string instance_type = 2;                      // "invalid" or "missing"
  bool feedback_mark = 3;                        // feedback_mark field
  string feedback_comment = 4;                   // feedback_comment field
  string feedback_user = 5;                      // feedback_user UUID
  string error_id = 6;                           // error_id UUID
  string version_id = 7;                         // version_id UUID  
  string technical_specification_name = 8;       // name from technical_specifications table
}